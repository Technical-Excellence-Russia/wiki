# Чистый код (Clean Code)

## Что такое Чистый Код?

__Чистый Код (Clean Code)__ - это код, который просто читать и просто изменять.

Определение было введено Робертом Мартином в начала 2000-х и описано в его одноимённой книге. Оно появилось, как противоположность плохому или "грязному" кода.

### Характеристики Чистого Кода:

- Хорошо решает одну задачу и является таким решением, к которому нечего добавить
- Является "элегантным", легко читаемым и очевидным для всех разработчиков
- Соответствует стандартам разработки языка, на котором он написан
- Проходит все тесты (код которых также "чистый")  
- Содержит минимум сущностей (классов, методов, функций) и зависимостей
- Обладает низкой цикломатической сложностью (количеством ветвлений)
- Не содержит дубликатов — принцип [DRY](https://ru.wikipedia.org/wiki/Don%E2%80%99t_repeat_yourself)  
- Не требует дорогостоящей поддержки
- ...

## Зачем писать Чистый Код?

Мартин Фаулер так оценивает качество кода:

> Любой дурак может написать код, понятный компьютеру. Хороший разработчик пишет код, понятный человеку.

По мере увеличение количество строк кода в системе она, как правило, утрачивает способность так же быстро меняться, как это было на старте проекта. Как правило, кривая производительности неуклонно снижается. Заказчикам приходится отказываться от многих фич, потому что они не смогут их представить рынку в нужное время.

В какой-то момент времени скорость падает до близкой к нулю, и принимается решение переписать "всё заново", что влечёт за собой новые затраты сил и времени. Часто гонка "старой" системы и новой продолжается несколько лет, т.к. компания не может просто выбросить старую систему, в которой работают пользователи.

Чтобы код оставался действительно "мягким" (software) и мог эволюционировать вместе с требованиями к нему, а не превращался в что-то жёсткое и плохо пахнущее, существуют, в том числе практики по написанию Чистого Кода.

В современном мире мы, как разработчики, не можем знать все требования наперёд (да и в целом с предсказанием будущего есть некоторые сложности). Такие требования никому не могут быть известны, пока продукт не начнут использовать конечные потребители. Поэтому всё большую популярность набирают подходы в разработке сложных продуктов с частыми поставками. Эффект от применения таких подходов становиться ещё сильнее, если разработчики следуют техническому совершенству в целом, и практикам чистого кода в частности. Писать качественный код быстрее и проще, используя подход [TDD](TDD.md).

Да и красивый, простой, чистый код писать и развивать гораздо приятнее. Вряд ли кто-то хочет другого. Не так ли? ;)

## Рекомендации

### Имена

#### Передавайте через имена свои намерения

Так можно назвать переменную "срок кредита в месяцах":

```java
var m = ...;
```

Но лучше написать полностью:

```java
var loanTermInMonth = ...;
```

#### Избегайте кодирования типа в имени  

- Избегайте дезинформации (например инверсии булевых переменных)
- Используйте удобопроизносимые имена
- Используйте термины предметной области
- Выбирайте имена и соблюдайте их орфографию, чтобы упростить поиск в будущем
- Меняйте имена, если они перестают быть актуальными
- ...

Пример обхода всех пустых зрительных мест в зале кинотеатра:

```java
for (int i = 0; i < list.size(); i++) {
    for (int j = 0; j < list[i].size(); j++) {
        check(i, j);
        // ...
    }
}
```

Как можно было написать тот же код с использованием более понятных имен:

```java
for (int rowNumber = 0; rowNumber < rowsOfseatsInCinemaHall.size(); rowNumber++) {
    for (int seatNumber = 0; seatNumber < rowsOfseatsInCinemaHall[rowNumber].size(); seatNumber++) {
        checkIfEmpty(rowNumber, seatNumber);
        // ...
    }
}
```

### Методы и функции

Несколько важных рекомендаций:

- Выбирайте название функции должно быть глаголом, а аргументы — существительными  
- Минимальное количество аргументов или объекты-обёртки
- Выходных аргумент стоит избегать
- Правило одной операции (должна выполнять только одну операцию)
- [Разделение команд и запросов](CommandQuerySeparation.md)
- Компактность (не более 20 строк)
- Один уровень абстракции
- Команды switch лучше описывать через шаблоны, например через Абстрактную фабрику
- Используйте исключения вместо возвращения кодов ошибок
- Выносите дублирующие шаги в отдельные блоки (DRY)
- ...


Пример метода с "запахами":

```java
public int check(int[] a, int b, float x, String outMessage) {
    int c = sum(b) + b * x;
    renderHTML("Result" + c);
    switch(c) {
        case 1: outMessage = "ok"; 
        case 0: outMessage = "ok"; 
        case -1: outMessage = "ok";
        default:  outMessage = "error";
    }
    return 0;
}
```

А вот пример более чистого кода:

```java
public int getPerimeter(Recangle r) {
    return 2 * (r.getWidth() + r.getHeight());
}

public int getArea(Recangle r) {
    return r.getWidth() * r.getHeight();
}
```

### Объекты, классы и структуры данных

- Следует избегать цепочки вызовов методов (это может привести к "крушению поезда" при возвращении null одним из методов)
- Хорошим тоном будет использование DTOs (data transfer objects)
- Классы, спроектированные с учётом принципов [SOLID](SOLID.md), имеют меньше шансов "замусориться"

Возможно "крушение поезда", если, например, ```getScratchDir()``` вернёт ```null```:

```java
final String outputDir = ctxt.getOptions().getScratchDir().getAbsolutePath()
```

Как можно было написать:

```java
Options opts = ctxt.getOptions();
File scratchDir = opts.getScratchDir();
final String outputDir = scratchDir.getAbsolutePath();
```

### Модульные тесты

О них вы можете подробнее узнать из статей про [xUnit](Xunit.md) и [Модульные тестах](UnitTest.md).

### Комментарии

В общем случае наличие комментариев с деталями реализации указывает на то, что код не может быть прочитан и понят сразу. Это является запахом "грязного" кода. Такие комментарии часто устаревают и вводят в заблуждениях всех, кто пытается разобраться с этим кодом.

"Закомментированные" функции, методы или их части также не имеет смысла при использовании VCS (Git, SVN, ...), когда код можно восстановить на любую дату в прошлом в пару кликов мыши. То же относиться и к логу изменений, указанию прошлых редакторов — всю эту информацию можно делегировать к системе контроля версий.

Но есть ряд случаев, когда комментарии могут быть полезны:

- Метки TODO, которые указывает на намерение что-то улучшить
- Комментарии в стиле xDoc (Javadoc, PHPdoc, ...) полезны, например при разработке публичного API
- Юридическая информация, вид лицензии, ...
- ...


## Как сделать существующий код "чище"?

Помните, что перед экспериментами с кодом, даже на первый взгляд очень очевидными, было бы полезно покрыть этот код тестами. Это поможет вам сэкономить много времени и нервов! А в статье о [Рефакторинге](Refactoring.md) можно найти несколько способов, как безопасно улучшить свой существующий код.

## Видео

- [Clean Code - Uncle Bob / Lesson 1](https://youtu.be/7EmboKQH8lM "Clean Code - Uncle Bob / Lesson 1")
- [Clean Code! by Lacht p1](https://youtu.be/4LUNr4AeLZM "Clean Code! by Lacht p1")
- [Clean Code! by Lacht p2](https://youtu.be/HNVJSGYUIjc "Clean Code! by Lacht p2")

## Книги

- [Clean Code: A Handbook of Agile Software Craftsmanship, Robert C. Martin, 2008](https://www.amazon.com/Clean-Code-Handbook-Software-Craftsmanship/dp/0132350882)
- [Чистый код. Создание анализ и рефакторинг, Роберт К. Мартин, 2019](https://www.ozon.ru/context/detail/id/142429922/)

Адаптировал: [Кротов Артём](https://fb.com/artem.v.krotov).

Остались вопросы? Задавай в [нашем чате](https://t.me/technicalexcellenceru).
